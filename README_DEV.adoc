== Developpers: How to setup your environment and be ready to code

You can either use CQFD to run testing tools in a container or install the tools on your machine.
CQFD is better for testing quickly but if you plan to modify the code and commit,
you would probably prefer local installation which integrate with pre-commit.

=== Option 1: Quick Setup with CQFD (No local installation)

==== Setup CQFD and Docker

* Install Docker: https://docs.docker.com/engine/install/

Make sure Docker runs without requiring `sudo`. To do so, add your user to the `docker` group:

[source,bash]
----
sudo groupadd docker
sudo usermod -aG docker $USER
----

Log out and log back in to apply the changes.

* Install CQFD:

[source,bash]
----
git clone https://github.com/savoirfairelinux/cqfd.git
cd cqfd
sudo make install
----

For more information, visit the CQFD GitHub repository: https://github.com/savoirfairelinux/cqfd

==== Initialize CQFD for this project

Once installed, initialize the container image:

[source,bash]
----
cqfd init
----

NOTE: This only needs to be done once, unless the container definition (`.cqfd/docker/Dockerfile`) is modified.

=== Option 2: Local Development Setup (Recommended for Contributors)

1. Ensure the following tools are installed on your system:
   - `make`
   - `Docker`
   - `Python 3`
   - `Node.js` and `npm`

2. Install backend development dependencies:

[source,bash]
----
pip install -r requirements/dev.txt
----

3. Set up pre-commit for automatic code linting:

[source,bash]
----
pip install pre-commit
pre-commit install
----

5. Install frontend development dependencies:

[source,bash]
----
cd frontend
nvm use 20
npm install --include=dev
----

== Testing (Unit + Integration)

Run the full test suite (backend + frontend):

[source,bash]
----
cqfd -b test
# or
make -C tests
----

Run tests separately (only for local setup):

[source,bash]
----
make -C tests test_backend
make -C tests test_frontend
----

Test Docker image build:

6. The script will push the tag to the remote repository. This will trigger the CI pipeline to build and publish the new docker image.

[source,bash]
----
export BUILD_TAG="$(pwgen -n 12 -1)"
make -C tests docker_build docker_test docker_clean
----

== Publishing a new version

We use [Semantic Versioning 2.0.0](https://semver.org/) prefixed with `v`, e.g., `v1.2.3` or `v1.2.3+build.4`.

1. Determine the next version number.
2. Create a release tag:

[source,bash]
----
ci/release_tag.sh v1.0.0-rc.1
----

3. The script will update relevant files. Review changes carefully.
   Press `Ctrl+C` to cancel if anything is incorrect.

4. After validation, the script will propose a `git review`.
   Confirm by typing `yes`, or cancel with `Ctrl+C`.

5. Enter a tag message when prompted.
   - Leave it blank to use the default message `Release v*.*.*`
   - Cancel with `Ctrl+C` to skip tag creation (e.g., if review is still pending)

6. The script will push the tag and trigger a Jenkins pipeline to build and publish the Docker image.

== Code quality and linting

=== Python backend (Flask)

- Linter: `flake8`
- Type checking (from tests/ folder): `mypy --config-file tox.ini`
- Unit tests: `pytest`
- Coverage (terminal): `pytest --cov=src`
- Coverage (HTML): `pytest --cov-report html --cov=src`

=== Frontend (React + TypeScript)

- Dev server: `npm run dev`
- Build: `npm run build`
- Unit tests: `npm run test` (uses Jest + Testing Library)
- Linter: `npm run lint` (ESLint)
- Coverage report: `npm run coverage`

To build the documentation as PDF:

[source,bash]
----
asciidoctor-pdf README.adoc
----

NOTE: Running `make test` will execute all linters and tests. If `pre-commit` is installed, `flake8` will also run on every commit.  
With CQFD, use `cqfd -b test` to run the full suite.

== Pre-commit hook

We use `pre-commit` to automatically run `flake8` before every commit.

To enable it:

[source,bash]
----
pip install pre-commit
pre-commit install
----

This helps enforce code quality and consistency across all contributions.

To ensure a good quality of code, we use pre-commit to run flake8 before commiting.
To install pre-commit, run `pip install pre-commit`.
Then, to enable pre-commit, run `pre-commit install`.